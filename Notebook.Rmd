---
title: "Feminizide in Medien - Datenerhebung"
output: html_notebook
---

# Setup

```{r setup, include=FALSE}
library(httr)
library(jsonlite)
library(yaml)
library(dotenv)
library(R6)

# API Wrapper laden
source("swissdox_api.R")
```

# Datenerhebung: Feminizide und Familiendrama

```{r api-setup}
# API Client initialisieren
client <- SwissdoxAPI$new()
```

## Query für Feminizid-Berichterstattung

```{r feminizid-data-collection}
# Erweiterte Query für alle relevanten Begriffe
feminizid_query <- '
query:
  dates:
    - from: 2000-01-01
      to: 2023-12-31
  languages:
    - de
    - fr
  content:
    OR:
      - Feminizid
      - Femizid
      - Frauenmord
      - Femicide
      - Familiendrama
      - "häusliche Gewalt"
      - "Partnerschaftsgewalt"
      - "Gewalt gegen Frauen"
      - "Tötung von Frau"
      - "Mord an Frau"
      - "Beziehungstat"
      - "Ehestreit"
      - "Familientragödie"
result:
  format: TSV
  maxResults: 10000000
  columns:
    - id
    - pubtime
    - medium_code
    - medium_name
    - rubric
    - regional
    - doctype
    - doctype_description
    - language
    - char_count
    - dateline
    - head
    - subhead
    - article_link
    - content_id
    - content
version: 1.2
'

# Eindeutigen Query-Namen mit Timestamp erstellen
query_name <- paste("Feminizid_Familiendrama_2023", format(Sys.time(), "%Y%m%d_%H%M%S"), sep = "_")

# Syntax-Test
test_result <- client$submit_query(
  query = feminizid_query,
  name = paste(query_name, "TEST", sep = "_"),
  test = TRUE
)

if (test_result$result == "ok") {
  message("✓ Query-Syntax ist korrekt")
  
  # Echte Query senden
  result <- client$submit_query(
    query = feminizid_query,
    name = query_name,
    comment = "Vollständige Erhebung: Feminizide, Familiendrama und häusliche Gewalt 2023"
  )
  
  query_id <- result$queryId
  message("Query gesendet. ID: ", query_id)
  message("Query Name: ", query_name)
  
  # Status prüfen
  status <- client$get_query_status(query_id)
  
  if (status$status %in% c("finished", "completed")) {
    message("✓ Query bereits abgeschlossen")
    message("Gefundene Artikel: ", status$actualResults)
    
    # Daten herunterladen
    if (!is.null(status$downloadUrl)) {
      filename <- basename(status$downloadUrl)
      downloaded_file <- client$download_dataset(filename, file.path("data", filename))
      
      # Daten laden
      media_data <- read.table(downloaded_file, sep = "\t", header = TRUE, 
                              quote = "", stringsAsFactors = FALSE,
                              encoding = "UTF-8")
      
      # Datum konvertieren
      media_data$pubtime <- as.POSIXct(media_data$pubtime)
      media_data$pub_date <- as.Date(media_data$pubtime)
      
      # Datenübersicht
      cat("\n=== DATENERHEBUNG ABGESCHLOSSEN ===\n")
      cat("Datei:", downloaded_file, "\n")
      cat("Anzahl Artikel:", nrow(media_data), "\n")
      cat("Zeitraum:", min(media_data$pub_date, na.rm = TRUE), "bis", max(media_data$pub_date, na.rm = TRUE), "\n")
      cat("Medien:", length(unique(media_data$medium_name)), "verschiedene\n")
      cat("Sprachen:", paste(unique(media_data$language), collapse = ", "), "\n")
      
      # Speichere Query-ID für Referenz
      cat("Query-ID für Referenz:", query_id, "\n")
      
    } else {
      message("Fehler: Keine Download-URL verfügbar")
    }
    
  } else {
    message("Query läuft noch. Status: ", status$status)
    message("Verwenden Sie client$wait_for_completion('", query_id, "') um zu warten")
  }
  
} else {
  message("Query-Syntax fehlerhaft")
}
```